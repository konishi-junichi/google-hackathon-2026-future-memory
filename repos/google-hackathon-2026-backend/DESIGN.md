# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ç›®æ¬¡
- [1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#1-ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
- [2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#2-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
- [3. AI ã‚µãƒ¼ãƒ“ã‚¹ã®é€£æº](#3-ai-ã‚µãƒ¼ãƒ“ã‚¹ã®é€£æº)
- [4. API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](#4-api-ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹)
    - [4.1 æ—…è¡Œãƒ—ãƒ©ãƒ³ä½œæˆ (Personal Mode)](#41-æ—…è¡Œãƒ—ãƒ©ãƒ³ä½œæˆ-personal-mode-apiv1plan)
    - [4.2 ãƒ—ãƒ©ãƒ³æ¤œç´¢ (Social Mode)](#42-ãƒ—ãƒ©ãƒ³æ¤œç´¢-social-mode-apiv1search)
- [4.3 ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯](#43-ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯-apiv1media-apiv1report)
    - [4.4 èªè¨¼ (Auth)](#44-èªè¨¼-auth-apiv1auth)
    - [4.5 ãƒ¦ãƒ¼ã‚¶ãƒ¼ (User)](#45-ãƒ¦ãƒ¼ã‚¶ãƒ¼-user-apiv1users)
- [5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & ãƒ‡ãƒ—ãƒ­ã‚¤](#5-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£--ãƒ‡ãƒ—ãƒ­ã‚¤)

---

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

**AI Travel Experience Designer Backend** ã¯ã€ã€ŒFuture Memoriesã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ”¯ãˆã‚‹ RESTful API ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ½œåœ¨çš„é¡˜æœ›ã‚’å½¢ã«ã™ã‚‹**ã€ŒPersonal Modeã€**ã¨ã€ä»–è€…ã®è‰¯è³ªãªä½“é¨“ã‚’å†åˆ©ç”¨ã™ã‚‹**ã€ŒSocial Modeã€**ã®2ã¤ã®ä½“é¨“ã‚’æä¾›ã—ã¾ã™ã€‚

### ä¸»è¦æ©Ÿèƒ½
1.  **Personal Mode (AIç”Ÿæˆ)**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã«åŸºã¥ãã€Gemini ãŒã‚¼ãƒ­ã‹ã‚‰æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’å‰µé€ ã—ã¾ã™ã€‚
2.  **Social Mode (æ¤œç´¢ãƒ»å¾ªç’°)**: Vertex AI Search ã‚’æ´»ç”¨ã—ã€ä»–è€…ã®å®Ÿç¸¾ãƒ—ãƒ©ãƒ³ã‚„ SNS å‹•ç”»è³‡ç”£ã‚’æ¤œç´¢ãƒ»å‚ç…§ã—ã¾ã™ã€‚
3.  **Core Ecosystem (å¾ªç’°)**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½“é¨“ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã—ã€ãƒ—ãƒ©ãƒ³ã®è©•ä¾¡ã‚„æ–°è¦ãƒ—ãƒ©ãƒ³ã¨ã—ã¦ã®é‚„æµã‚’è¡Œã„ã¾ã™ã€‚

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: FastAPI (Python 3.12+)
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ & æ¤œç´¢**: BigQuery / Vertex AI Search for Structured Data
- **AI ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**: Google Cloud Vertex AI / Gemini API (gemini-3-flash-preview æ¨å¥¨)
- **ãƒ‡ãƒ—ãƒ­ã‚¤**: Google Cloud Run

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
graph LR
    Client[Front: React] -->|HTTP/JSON| API[Backend: FastAPI]
    
    subgraph Google Cloud
        API -->|GenAI| Gemini[Gemini 2.0 Flash]
        API -->|Search| VSearch[Vertex AI Search]
        VSearch -.->|Index| BQ[(BigQuery: Plans/Videos)]
    end
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
1.  **ãƒ—ãƒ©ãƒ³ç”Ÿæˆ**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ -> API -> Gemini -> 3ã¤ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆææ¡ˆ
2.  **ãƒ—ãƒ©ãƒ³æ¤œç´¢**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ -> API -> Vertex AI Search -> é©åˆã™ã‚‹æ—¢å­˜ãƒ—ãƒ©ãƒ³ã®è¿”å´
3.  **å‹•ç”»é€£æº**: BigQuery (VideoAssets) ã«è“„ç©ã•ã‚ŒãŸ SNS å‹•ç”»ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã—ã€ãƒ—ãƒ©ãƒ³ã«æœ€é©ãªã€Œãƒªã‚¢ãƒ«ãªæ˜ åƒã€ã‚’åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚

---

## 3. AI ã‚µãƒ¼ãƒ“ã‚¹ã®é€£æº

### 3.1 Gemini (Generative AI)
- **å½¹å‰²**: æ–°è¦ãƒ—ãƒ©ãƒ³ã®å‰µé€ ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ›–æ˜§ãªè¦æœ›ã®å…·ä½“åŒ–ã€æ—¢å­˜ãƒ—ãƒ©ãƒ³ã®ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ— (AI Concierge)ã€ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã®é‡è¤‡åˆ¤å®šã€‚
- **ãƒ¢ãƒ‡ãƒ«**: `gemini-3-flash-preview` (é«˜é€Ÿã‹ã¤ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œ)

### 3.2 Vertex AI Search (Information Retrieval)
- **å½¹å‰²**: è“„ç©ã•ã‚ŒãŸ `Plans` ãŠã‚ˆã³ `VideoAssets` ã‹ã‚‰ã€è‡ªç„¶è¨€èªã‚¯ã‚¨ãƒªã‚„å±æ€§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§æœ€é©ãªæƒ…å ±ã‚’æ¤œç´¢ã€‚
- **æ¤œç´¢å¯¾è±¡**:
    - **Plans**: éå»ã®æ—…è¡Œãƒ—ãƒ©ãƒ³ã€å£ã‚³ãƒŸã€è©•ä¾¡ã€‚
    - **VideoAssets**: å ´æ‰€ã‚„é›°å›²æ°—ã«ç´ã¥ã„ãŸ SNS å‹•ç”»ã€‚

---

## 4. API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### 4.1 æ—…è¡Œãƒ—ãƒ©ãƒ³ä½œæˆ (Personal Mode) (`/api/v1/plan`)

#### ğŸ·ï¸ **äººæ°—ã‚¿ã‚°ã®å–å¾— (Get Popular Tags)**
ææ¡ˆä½œæˆæ™‚ã«é¸æŠå¯èƒ½ãªäººæ°—ã®ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/plan/tags`
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
  ```json
  {
    "tags": [
      "æ­´å²å·¡ã‚Š",
      "ã‚°ãƒ«ãƒ¡",
      "çµ¶æ™¯",
      ...
    ]
  }
  ```

#### ğŸ›« **ææ¡ˆã®ç”Ÿæˆ (Generate Proposals)**
ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§(Mode)ã«åŸºã¥ãã€3ã¤ã®æ–°è¦ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/plan/proposals`
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
  ```json
  {
    "mode": "senior", // senior, family, solo, active, ladies
    "pref_locations": ["Kyoto"], // Optional
    "selected_tags": ["history", "quiet"], // Optional
    "custom_attributes": "Avoid stairs", // Optional
    "nights": 2, // Optional, default 1
    "departure_location": "Tokyo", // Optional
    "language": "ja"
  }
  ```
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
  ```json
  [
    {
      "id": 101,
      "title": "é™å¯‚ã®äº¬éƒ½ç¦…å¯ºå·¡ã‚Š",
      "tagline": "å–§é¨’ã‚’é›¢ã‚Œã€å¿ƒæ•´ã†ã²ã¨ã¨ãã‚’",
      "desc": "æœ‰åãªè¦³å…‰åœ°ã‚’é¿ã‘ã€éš ã‚ŒãŸååˆ¹ã‚’å·¡ã‚‹...",
      "match": 95,
      "color": "from-slate-700 to-slate-500",
      "location": "Kyoto, Japan"
    }
    // ... total 3 items
  ]
  ```

#### ğŸ—“ï¸ **è¡Œç¨‹è¡¨ã®ç”Ÿæˆ (Generate Itinerary)**
é¸æŠã•ã‚ŒãŸææ¡ˆã®è©³ç´°ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/plan/itinerary`
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
  ```json
  {
    "proposalId": 101,
    "language": "ja"
  }
  ```
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
  ```json
  {
    "proposalId": 101,
    "schedule": [
      {
        "time": "10:00",
        "activity": "å¤§å¾³å¯ºã§åç¦…ä½“é¨“",
        "icon": "temple",
        "location": {"lat": 35.044, "lng": 135.746},
        "description": "åˆå¿ƒè€…ã§ã‚‚å®‰å¿ƒã®æŒ‡å°ä»˜ã..."
      }
    ],
    "souvenirs": [
      {
        "name": "äº¬è“å­",
        "price": "Â¥1,200"
      }
    ]
  }
  ```

---

### 4.2 ãƒ—ãƒ©ãƒ³æ¤œç´¢ (Social Mode) (`/api/v1/search`)

#### ğŸ” **æ—¢å­˜ãƒ—ãƒ©ãƒ³ã®æ¤œç´¢ (Search Plans)**
Vertex AI Search ã‚’çµŒç”±ã—ã¦ã€ä»–è€…ã®ãƒ—ãƒ©ãƒ³ã‚’æ¤œç´¢ã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/search/plans`
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
  ```json
  {
    "query": "äº¬éƒ½ ç©´å ´ æ­´å²",
    "filter": {
       "mode": "senior" // Optional
    },
    "limit": 10
  }
  ```
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
  ```json
  {
    "results": [
      {
         "plan_id": "uuid-...",
         "title": "æ—©æœã®æ¸…æ°´å¯ºã¨å‘¨è¾ºæ•£ç­–",
         "description": "æ··é›‘ã™ã‚‹å‰ã«è¡Œãã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™...",
         "match_reason": "ã€Œæ­´å²ã€ã€Œç©´å ´ã€ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ä¸€è‡´",
         "thumbnail": "...",
         "tags": ["history", "morning"],
         "author": "UserA"
      }
    ]
  }
  ```

---

### 4.3 ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ (`/api/v1/media`, `/api/v1/report`)

#### ğŸ¬ **ãƒ¡ãƒ‡ã‚£ã‚¢ææ¡ˆ (Get Media)**
(è£œå®Œçš„API) ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„å ´æ‰€ã«é–¢é€£ã™ã‚‹å‹•ç”»ã‚’æ¤œç´¢ã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/media/search`

#### ğŸ“¹ **å‹•ç”»ç”Ÿæˆ (Generate AI Video)**
Google Veo 3.1 Fast ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—…è¡Œå…ˆã«ã„ã‚‹å‹•ç”»ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/media/video`
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
  ```json
  {
    "proposalId": 101,
    "title": "é™å¯‚ã®äº¬éƒ½ç¦…å¯ºå·¡ã‚Š",
    "description": "å–§é¨’ã‚’é›¢ã‚Œã€å¿ƒæ•´ã†ã²ã¨ã¨ãã‚’...",
    "user_profile_image_url": "gs://...",
    "user_id": 1
  }
  ```
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
  ```json
  {
    "video_url": "https://storage.googleapis.com/..."
  }
  ```

#### ğŸ“ **ãƒ¬ãƒãƒ¼ãƒˆæŠ•ç¨¿ (Submit Report)**
æ—…è¡Œå¾Œã®è©•ä¾¡ã‚„ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚AIãŒå†…å®¹ã‚’è©•ä¾¡ã—ã€æ–°è¦ãƒ—ãƒ©ãƒ³ã¨ã—ã¦ç™»éŒ²ã™ã‚‹ã‹æ—¢å­˜ã¸ã®çµ±åˆã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/report`
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
  ```json
  {
    "plan_id": "uuid-...", // å…ƒã«ãªã£ãŸãƒ—ãƒ©ãƒ³ãŒã‚ã‚Œã°
    "comment": "æœ€é«˜ã§ã—ãŸï¼ãŸã ã€ãƒã‚¹ã¯æ··ã‚€ã®ã§ã‚¿ã‚¯ã‚·ãƒ¼æ¨å¥¨ã€‚",
    "rating": 5,
    "photos": []
  }
  ```
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
  ```json
  {
    "status": "success",
    "ai_analysis": "Existing plan updated with traffic tip." // çµ±åˆçµæœ
  }
  ```

---

---

### 4.4 èªè¨¼ (Auth) (`/api/v1/auth`)

#### ğŸ” **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² (Register)**
æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/auth/register`
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
  ```json
  {
    "username": "traveler01",
    "password": "securepassword",
    "age": 30,
    "gender": "male", // optional
    "address": "Tokyo, Japan" // optional
  }
  ```
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
  ```json
  {
    "user_id": 1,
    "username": "traveler01"
  }
  ```

#### ğŸ”‘ **ãƒ­ã‚°ã‚¤ãƒ³ (Login)**
ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§èªè¨¼ã—ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³(JWT)ã‚’ç™ºè¡Œã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/auth/token`
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: Content-Type: `application/x-www-form-urlencoded`
  - `username`: ãƒ¦ãƒ¼ã‚¶ãƒ¼å
  - `password`: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
  ```json
  {
    "access_token": "ey...",
    "token_type": "bearer"
  }
  ```

---

### 4.5 ãƒ¦ãƒ¼ã‚¶ãƒ¼ (User) (`/api/v1/users`)

#### ğŸ‘¤ **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾— (Get Profile)**
ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/users/me`
- **ãƒ˜ãƒƒãƒ€ãƒ¼**: `Authorization: Bearer <token>`
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
  ```json
  {
    "user_id": 1,
    "username": "traveler01",
    "profile_image_url": "https://storage.googleapis.com/...",
    "age": 30,
    "gender": "male",
    "address": "Tokyo, Japan"
  }
  ```

#### âœï¸ **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–° (Update Profile)**
ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ç”»åƒå«ã‚€ï¼‰ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `PUT /api/v1/users/me`
- **ãƒ˜ãƒƒãƒ€ãƒ¼**: `Authorization: Bearer <token>`
- **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: Multipart/Form-Data (ç”»åƒå¯¾å¿œ) ã¾ãŸã¯ JSON
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: æ›´æ–°å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±

#### ğŸ“‚ **è‡ªåˆ†ã®ãƒ—ãƒ©ãƒ³ä¸€è¦§ (Get My Plans)**
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆãƒ»ä¿å­˜ã—ãŸãƒ—ãƒ©ãƒ³å±¥æ­´ã‚’å–å¾—ã—ã¾ã™ã€‚

- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/users/me/plans`
- **ãƒ˜ãƒƒãƒ€ãƒ¼**: `Authorization: Bearer <token>`

---

## 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & ãƒ‡ãƒ—ãƒ­ã‚¤


- **CORS**: é–‹ç™ºç’°å¢ƒ(`localhost`), æœ¬ç•ªç’°å¢ƒãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã€‚
- **èªè¨¼**: å°†æ¥çš„ã«ã¯ Firebase Auth ç­‰ã¨é€£æºã—ã€`user_id` ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã§æ¤œè¨¼ã€‚
